import{o as r,u as l,b as x,s as o,n as v,_ as g,a as d,l as a,r as _,D as Z,B as H}from"./index-CQq7ZMLi.js";const V={id:"1",name:"qododqsdqsdqs",file_type:"binary",platform:["windows"],size:46846,created_by:"api-client-a46eaf57d6634baa84e3f43b2af00cb2",created_by_uuid:"a46eaf57-d663-4baa-84e3-f43b2af00cb2",created_timestamp:"2023-09-20T09:30:55.143982484Z",modified_by:"api-client-a46eaf57d6634baa84e3f43b2af00cb2",modified_timestamp:"2023-09-20T09:30:55.14398269Z",sha256:"e124293e578c684a161f8d726ae13771d5cdc08f2e278d479b60172fb9832b4c",permission_type:"none",run_attempt_count:0,run_success_count:0,share_with_workflow:!1,workflow_is_disruptive:!1},G={id:"2",name:"qsdqssqdsqd",file_type:"binary",platform:["windows"],size:46846,created_by:"api-client-a46eaf57d6634baa84e3f43b2af00cb2",created_by_uuid:"a46eaf57-d663-4baa-84e3-f43b2af00cb2",created_timestamp:"2023-09-20T09:23:07.32929316Z",modified_by:"api-client-a46eaf57d6634baa84e3f43b2af00cb2",modified_timestamp:"2023-09-20T09:23:07.329293366Z",sha256:"e124293e578c684a161f8d726ae13771d5cdc08f2e278d479b60172fb9832b4c",permission_type:"none",run_attempt_count:0,run_success_count:0,share_with_workflow:!1,workflow_is_disruptive:!1},j={id:"3",name:"qsdsd",file_type:"binary",platform:["windows"],size:46846,created_by:"api-client-a46eaf57d6634baa84e3f43b2af00cb2",created_by_uuid:"a46eaf57-d663-4baa-84e3-f43b2af00cb2",created_timestamp:"2023-09-21T09:28:58.222043877Z",modified_by:"api-client-a46eaf57d6634baa84e3f43b2af00cb2",modified_timestamp:"2023-09-21T09:28:58.222044046Z",sha256:"e124293e578c684a161f8d726ae13771d5cdc08f2e278d479b60172fb9832b4c",permission_type:"none",run_attempt_count:0,run_success_count:0,share_with_workflow:!1,workflow_is_disruptive:!1},y=[{id:"abc123",name:"Mitre hosts"},{id:"def456",name:"RTR hosts"},{id:"ghi789",name:"Response hosts"}],$=[{name:"groups",buckets:[{label:"abc123",count:42},{label:"def456",count:23}]}],M=[{device_id:"xyz987",hostname:"Odysseus"},{device_id:"mno654",hostname:"Agamemnon"},{device_id:"pqr321",hostname:"Achilles"}],I=[{uuid:"uuid1",cid:"cid",uid:"f.bird@crowdstrike.com",first_name:"Falcon",last_name:"Bird",created_at:"2023-09-12T14:35:46Z"},{uuid:"uuid2",cid:"cid",uid:"p.bird@crowdstrike.com",first_name:"Peregrine",last_name:"Bird",created_at:"2023-09-12T14:35:46Z"},{uuid:"uuid3",cid:"cid",uid:"r.dino@crowdstrike.com",first_name:"Raptor",last_name:"Dino",created_at:"2023-09-12T14:35:46Z"}],B={user_id:"dummy",user_name:"dummy",version:0,id:"1",name:"First Job RR",description:"First Job RR description",notification_emails:null,notifications:["paul.rosset@crowdstrike.com"],draft:!0,tags:null,host_count:M.length,run_count:0,total_recurrences:0,action:{type:"installSoftware",install_file_path:"hello",command_switch:"world",file_name:V.name},schedule:{start_date:"2023-08-31T08:25:17.179Z"},target:{host_groups:null,hosts:M.map(s=>s.device_id),offline_queueing:!1},run_now:!1,next_run:"2023-09-02T08:25:17.179Z",last_run:"2023-09-02T08:25:17.179Z",created_at:"2023-09-02T08:25:17.179Z",updated_at:"2023-09-02T08:25:17.179Z",deleted_at:"2023-09-02T08:25:17.179Z"},Q={user_id:"dummy",user_name:"dummy",version:0,id:"2",name:"Second Job Test RR",description:"Second Job Test RR",notification_emails:null,notifications:null,draft:!1,tags:null,host_count:y.length,run_count:0,total_recurrences:0,action:{type:"removeFile",remove_file_name:"hello",remove_file_path:"world"},schedule:{start_date:"2023-08-31T08:25:17.179Z"},target:{host_groups:y.map(s=>s.id),hosts:null,offline_queueing:!0},run_now:!0,next_run:"2023-08-31T08:25:17.179Z",last_run:"2023-08-31T08:25:17.179Z",created_at:"2023-08-31T08:25:17.179Z",updated_at:"2023-08-31T08:25:17.179Z",deleted_at:"2023-08-31T08:25:17.179Z"},U={user_id:"dummy",user_name:"dummy",version:0,id:"3",name:"Third Job Test RR",description:"Third Job Test RR",notification_emails:null,notifications:null,draft:!1,tags:null,host_count:y.length,run_count:0,total_recurrences:0,action:{type:"removeFile",remove_file_name:"hello",remove_file_path:"world"},schedule:{start_date:"2023-08-31T08:25:17.179Z"},target:{host_groups:y.map(s=>s.id),hosts:null,offline_queueing:!0},run_now:!0,next_run:"2023-08-31T08:25:17.179Z",last_run:"2023-08-31T08:25:17.179Z",created_at:"2023-08-31T08:25:17.179Z",updated_at:"2023-08-31T08:25:17.179Z",deleted_at:"2023-08-31T08:25:17.179Z"},O={user_id:"dummy",user_name:"dummy",version:0,id:"4",name:"Fourth Job Test RR",description:"Fourth Job Test RR",notification_emails:null,notifications:null,draft:!1,tags:null,host_count:y.length,run_count:0,total_recurrences:0,action:{type:"removeFile",remove_file_name:"hello",remove_file_path:"world"},schedule:{start_date:"2023-08-31T08:25:17.179Z"},target:{host_groups:y.map(s=>s.id),hosts:null,offline_queueing:!0},run_now:!0,next_run:"2023-08-31T08:25:17.179Z",last_run:"2023-08-31T08:25:17.179Z",created_at:"2023-08-31T08:25:17.179Z",updated_at:"2023-08-31T08:25:17.179Z",deleted_at:"2023-08-31T08:25:17.179Z"},z={user_id:"dummy",user_name:"dummy",version:0,id:"5",name:"Fifth Job Test RR",description:"",notification_emails:null,notifications:null,draft:!1,tags:null,host_count:y.length,run_count:0,total_recurrences:0,action:{type:"removeFile",remove_file_name:"hello",remove_file_path:"world"},schedule:{start_date:"2023-08-31T08:25:17.179Z"},target:{host_groups:y.map(s=>s.id),hosts:null,offline_queueing:!0},run_now:!0,next_run:"2023-08-31T08:25:17.179Z",last_run:"2023-08-31T08:25:17.179Z",created_at:"2023-08-31T08:25:17.179Z",updated_at:"2023-08-31T08:25:17.179Z",deleted_at:"2023-08-31T08:25:17.179Z"},K={user_id:"dummy",user_name:"dummy",version:0,id:"6",name:"Sixth Job Test RR",description:"Sixth Job Test RR",notification_emails:null,notifications:null,draft:!1,tags:null,host_count:y.length,run_count:0,total_recurrences:0,action:{type:"removeFile",remove_file_name:"hello",remove_file_path:"world"},schedule:{start_date:"2023-08-31T08:25:17.179Z"},target:{host_groups:y.map(s=>s.id),hosts:null,offline_queueing:!0},run_now:!0,next_run:"2023-08-31T08:25:17.179Z",last_run:"2023-08-31T08:25:17.179Z",created_at:"2023-08-31T08:25:17.179Z",updated_at:"2023-08-31T08:25:17.179Z",deleted_at:"2023-08-31T08:25:17.179Z"},W={id:"1",job_id:"1",execution_id:"1",name:"First Job RR",run_date:"2023-08-11 09:35:29",duration:"00:12:21",status:"completed",hosts:["host1"],numHosts:1,receivedFiles:2,endDate:"2023-08-09 13:42:34"},X={id:"1",job_id:"1",job_name:"CVE-2023-123456",modified_at:"2023-08-11 09:35:29",version:1,modified_by:"g.thegrey@crowdstrike.com",action:"Created JobRTR"};function F(s){return s.type==="api"}function Y(s){return F(s)&&s.api==="faasGateway"}function ee(s){return F(s)&&s.api==="devices"}function te(s){return F(s)&&s.api==="userManagement"}function S(s){return F(s)&&s.api==="remoteResponse"}class se{isMatch(e){return ee(e)&&(e.method==="postAggregatesDevicesGetV1"||e.method==="getEntitiesGroupsV1"||e.method==="postEntitiesDevicesV2"||e.method==="getQueriesDevicesV2")}async responder(e){let t={};if(e.method==="postAggregatesDevicesGetV1")t={errors:[],resources:$};else if(e.method==="getEntitiesGroupsV1")t={errors:[],resources:y};else if(e.method==="getQueriesDevicesV2"){const i=M.map(n=>n.device_id);t={errors:[],resources:i}}else e.method==="postEntitiesDevicesV2"&&(t={errors:[],resources:M});return Promise.resolve(t)}}class oe{isMatch(e){return te(e)&&(e.method==="postEntitiesUsersGetV1"||e.method==="getQueriesUsersV1")}async responder(e){let t={};return e.method==="postEntitiesUsersGetV1"?t={errors:[],resources:I}:e.method==="getQueriesUsersV1"&&(t={errors:[],resources:I.map(i=>i.uuid)}),Promise.resolve(t)}}const ne={jobs:[],history:[],logs:[],rtrPutFiles:[]},Me={jobs:[B,Q,U,O,z,K],history:[W],logs:[X],rtrPutFiles:[V,G,j]},L=r({type:a("installSoftware"),install_file_path:o().optional(),command_switch:o().optional(),file_name:o()}),C=r({type:a("removeFile"),remove_file_name:o(),remove_file_path:o()}),ie=r({user_id:o(),user_name:o(),version:v(),name:o(),description:o(),notifications:l([g(),d(o())]),tags:l([g(),d(o())]),action:l([L,C]),run_now:x(),schedule:l([r({start_date:o()}),g()]),target:r({host_groups:l([g(),d(o())]),hosts:l([g(),d(o())]),offline_queueing:x()})});r({user_id:o(),user_name:o(),version:v(),id:o(),name:o(),description:o(),notification_emails:l([g(),d(o())]).optional(),notifications:l([g(),d(o())]),draft:x(),tags:l([g(),d(o())]),host_count:v(),run_count:v(),total_recurrences:v(),action:l([L,C]),schedule:l([r({start_date:o()}),g()]),target:r({host_groups:l([g(),d(o())]),hosts:l([g(),d(o())]),offline_queueing:x()}),run_now:x(),next_run:o(),last_run:o(),created_at:o(),updated_at:o(),deleted_at:o()});const re=r({method:o(),payload:r({body:r({function_id:o().optional(),function_name:o().optional(),payload:r({path:o()})})})}),ae=r({function_id:o().optional(),function_name:o().optional(),function_version:v(),payload:r({params:r({query:r({draft:d(l([a("true"),a("false")]))}).optional()}).optional(),body:ie})}),de=r({payload:r({body:r({payload:r({params:r({query:r({fieldName:l([a("name"),a("description"),a("last_run_date"),a("next_run_date"),a("hosts"),a("last_modified"),a("draft")]).optional(),direction:l([a("ASC"),a("DESC")]).optional(),limit:l([d(a("5")),d(a("10")),d(a("15")),d(a("20"))]).optional(),offset:d(o()).optional(),prev:d(o()).optional(),next:d(o()).optional()}).optional()}).optional()})})})}),ue=r({payload:r({body:r({payload:r({params:r({query:r({id:d(o())})})})})})}),E=":";class J{functionId="mock-faas-function";functionName="mock-faas-function-name";requestPath="/mock-path";counter=0;bus={};db;appName;constructor({db:e,appName:t}){this.db=e,this.appName=t}isMatch(e){return Y(e)&&(this.isPost(e)||this.isGet(e))}isPost(e){const t=re.safeParse(e);if(!t.success)return!1;const{method:i}=t.data,{function_id:n,function_name:u}=t.data.payload.body,{path:c}=t.data.payload.body.payload;return i==="postEntitiesExecutionV1"&&(n===this.functionId||u===this.functionName)&&c===this.requestPath}isGet(e){const{id:t}=e.payload.params;if(typeof t!="string")return!1;const[i,n,u,c]=t.split(E);return e.method==="getEntitiesExecutionV1"&&(i===this.functionId||n===this.functionName)&&u===this.requestPath}prepareResponse(e){return{errors:[],resources:[]}}async responder(e){if(this.isPost(e)){const t=[this.functionId,this.functionName,this.requestPath,++this.counter].join(E);return this.bus[t]=this.prepareResponse(e),Promise.resolve({resources:[{execution_id:t,function_id:this.functionId}]})}else if(this.isGet(e)){const{id:t}=e.payload.params;if(!t||typeof t!="string")throw"No id supplied";if(!this.bus[t])throw`No response for id: ${t}`;return Promise.resolve(this.bus[t])}}}class ce extends J{constructor(e){super(e),this.functionId=_.createJob.id,this.functionName=_.createJob.name,this.requestPath=_.createJob.path}prepareResponse(e){if(!("body"in e.payload))throw`CreateJobHandler received bad message: ${e.toString()}`;const i=ae.safeParse(e.payload.body);if(i.success){const n=this.db.jobs.findIndex(b=>b.name===i.data.payload.body.name);if(n>-1&&this.db.jobs[n].draft===!1)return{resources:[{function_id:this.functionId,function_name:this.functionName,function_version:1,payload:{body:null,errors:[{field:"jobName",message:`Job name "${i.data.payload.body.name}" already exists"`,code:102}],status_code:400}}]};const[u]=i.data.payload.params?.query?.draft??["false"],{version:c,...f}=i.data.payload.body,h={id:n>-1?this.db.jobs[n].id:(Math.random()+1).toString(36).substring(7),version:c+1,draft:u==="true",total_recurrences:0,run_count:0,host_count:0,next_run:"2023-12-01T12:00",last_run:"",created_at:"2023-12-01T12:00",updated_at:"2023-12-01T12:00",deleted_at:"",notification_emails:f.notifications,...f};return n===-1?this.db.jobs.unshift(h):n>-1&&this.db.jobs[n].draft===!0&&(this.db.jobs[n]=h),{errors:[],resources:[{function_id:this.functionId,function_name:this.functionName,function_version:1,payload:{body:{resource:"a_random_uid"},errors:[],status_code:200}}]}}else return{resources:[{function_id:this.functionId,function_name:this.functionName,function_version:1,payload:{body:null,errors:i.error.issues.map(n=>({message:n.message})),status_code:400}}]}}}r({job_name:o(),modified_at:o(),version:v(),modified_by:o(),action:o(),id:o(),job_id:o()});const le=r({payload:r({body:r({payload:r({params:r({query:r({fieldName:l([a("name"),a("date_modified"),a("version"),a("modified_by"),a("action_taken")]).optional(),direction:l([a("ASC"),a("DESC")]).optional(),limit:l([d(a("5")),d(a("10")),d(a("15")),d(a("20"))]).optional(),offset:d(o()).optional(),prev:d(o()).optional(),next:d(o()).optional(),page:v().optional(),id:d(o()).optional(),filter:d(o()).optional()}).optional()}).optional()})})})}),A=10;function pe(s,e,t){const i=Math.ceil((t+1)/e);return t===-1?{paginatedJobs:s,page:i}:{paginatedJobs:s.slice(t,t+(e+1)),page:i}}function fe(s,e,t,i,n){let u=s.findIndex(p=>p.id===t);n!==""?u=s.findIndex(p=>p.id===n):i!==""&&(u=s.findIndex(p=>p.id===i));const{paginatedJobs:c,page:f}=pe(s,e,u),m=s[u-e]?.id?`${s[u-e]?.id}:${f-1}`:"",h=s.slice(-1),b=c.length===e+1?`${h[0]?.id}:${f}`:"";return{currentPage:e?c.slice(0,e):c,prevCursor:m,nextCursor:b}}class _e extends J{constructor(e){super(e),this.functionId=_.getAuditLog.id,this.functionName=_.getAuditLog.name,this.requestPath=_.getAuditLog.path}prepareResponse(e){const{logs:t}=this.db,n=le.parse(e).payload.body.payload.params?.query??{},{offset:u=null,limit:c=[String(A)],prev:f=null,next:m=null}=n,h=u?.[0]??"",b=f?.[0].split(":")?.[0]??"",T=m?.[0].split(":")?.[0]??"",p=parseInt(c[0])??A;let R=t;if(n&&n.filter&&n.filter.length>0){const[xe,N]=n.filter[0].split(":");R=t.filter(k=>N.includes(k.job_id))}const{prevCursor:w,nextCursor:P,currentPage:q}=fe(R,p,h,b,T);return{errors:[],resources:[{function_id:this.functionId,function_version:1,payload:{body:{resources:R,meta:{total:t.length,limit:p,offset:q[0]?.id||"",count:q.length,prev:w,next:P}}}}]}}}class he{db;constructor({db:e}){this.db=e}isMatch(e){return S(e)&&e.method==="getEntitiesPutFilesV2"}responder(e){return Promise.resolve({errors:void 0,resources:this.prepareResponse(e)})}prepareResponse(e){const{ids:t}=e.payload.params;return!Array.isArray(t)||t.length===0?[]:this.db.rtrPutFiles.filter(i=>t.includes(i.id))}}class me extends J{constructor(e){super(e),this.functionId=_.getJobDetails.id,this.functionName=_.getJobDetails.name,this.requestPath=_.getJobDetails.path}prepareResponse(e){const{jobs:t}=this.db,n=ue.parse(e).payload.body.payload.params.query??{},u=t.find(c=>n.id.includes(c.id));return{errors:[],resources:[{function_id:this.functionId,function_version:1,payload:{body:{resource:u}}}]}}}function be(s,e,t){const i=Math.ceil((t+1)/e);return t===-1?{paginatedJobs:s,page:i}:{paginatedJobs:s.slice(t,t+(e+1)),page:i}}function ge(s,e,t,i,n){let u=s.findIndex(p=>p.id===t);n!==""?u=s.findIndex(p=>p.id===n):i!==""&&(u=s.findIndex(p=>p.id===i));const{paginatedJobs:c,page:f}=be(s,e,u),m=s[u-e]?.id?`${s[u-e]?.id}:${f-1}`:"",h=s.slice(-1),b=c.length===e+1?`${h[0]?.id}:${f}`:"";return{currentPage:e?c.slice(0,e):c,prevCursor:m,nextCursor:b}}class ye extends J{constructor(e){super(e),this.functionId=_.getJobs.id,this.functionName=_.getJobs.name,this.requestPath=_.getJobs.path}prepareResponse(e){const{jobs:t}=this.db,n=de.parse(e).payload.body.payload.params?.query??{},{offset:u=null,limit:c=[String(Z)],prev:f=null,next:m=null}=n,h=u?.[0]??"",b=f?.[0].split(":")?.[0]??"",T=m?.[0].split(":")?.[0]??"",p=parseInt(c[0])??Z,R=t,{prevCursor:w,nextCursor:P,currentPage:q}=ge(R,p,h,b,T);return{errors:[],resources:[{function_id:this.functionId,function_version:1,payload:{body:{resources:q,meta:{total:t.length,limit:p,offset:q[0]?.id||"",count:q.length,prev:w,next:P}}}}]}}}class ve{db;constructor({db:e}){this.db=e}isMatch(e){return S(e)&&e.method==="getQueriesPutFilesV1"}responder(e){return Promise.resolve({errors:void 0,resources:this.prepareResponse(e)})}prepareResponse(e){const{filter:t}=e.payload.params;if(t&&typeof t=="string"){const[i,n]=t.split(":"),u=n.replace(/[']/g,"");return this.db.rtrPutFiles.filter(c=>c.name.includes(u)).map(c=>c.id)}return this.db.rtrPutFiles.map(i=>i.id)}}r({id:o(),job_id:o(),execution_id:o(),name:o(),duration:o(),hosts:d(o()),numHosts:v(),receivedFiles:v(),run_date:o(),endDate:o(),status:o()});const Re=r({payload:r({body:r({payload:r({params:r({query:r({fieldName:l([a("name"),a("run_date"),a("status"),a("duration"),a("hosts")]).optional(),direction:l([a("ASC"),a("DESC")]).optional(),limit:l([d(a("5")),d(a("10")),d(a("15")),d(a("20"))]).optional(),offset:d(o()).optional(),prev:d(o()).optional(),next:d(o()).optional(),id:d(o()).optional(),filter:d(o()).optional(),exact_name:d(o()).optional()}).optional()}).optional()})})})}),D=10;function Te(s,e,t){const i=s.findIndex(n=>n.id===t);return s[i-e]?.job_id||""}function we(s,e,t){const i=s.findIndex(n=>n.id===t);return i===-1?s:s.slice(i,i+(e+1))}function Pe(s,e,t){const i=we(s,e,t),n=Te(s,e,t),u=s.slice(-1),c=i.length===e+1?u[0]?.id:"";return{currentPage:e?i.slice(0,e):i,prevCursor:n,nextCursor:c}}class qe extends J{constructor(e){super(e),this.functionId=_.getRunHistory.id,this.functionName=_.getRunHistory.name,this.requestPath=_.getRunHistory.path}prepareResponse(e){const{history:t}=this.db,n=Re.parse(e).payload.body.payload.params?.query??{},{offset:u=null,limit:c=[String(D)]}=n,f=u?.[0]??"",m=parseInt(c[0])??D;let h=t;if(n&&n.filter&&n.filter.length>0){const R=n.filter[0].split(":")[0],w=n.filter[0].split(":")[1];h=t.filter(P=>{if(R==="job_name"&&(n.exact_name?.length??!1))return n.exact_name?.[0]==="true"?w===P.name:w.includes(P.name);if(R==="job_id")return P.job_id===w})}const{prevCursor:b,nextCursor:T,currentPage:p}=Pe(h,m,f);return{errors:[],resources:[{function_id:this.functionId,function_version:1,payload:{body:{resources:p,meta:{total:h.length,limit:m,count:p.length,prev:b,next:T}}}}]}}}class Fe extends H{createJob;getJobs;getJobDetails;getAuditLog;getRunHistory;getQueriesPutFilesV1;getEntitiesPutFilesV2;devices;userManagement;db;constructor({db:e,appName:t}={db:ne,appName:"rapid-response"}){super(),this.db=e,this.createJob=new ce({db:this.db,appName:t}),this.getJobs=new ye({db:this.db,appName:t}),this.getJobDetails=new me({db:this.db,appName:t}),this.getAuditLog=new _e({db:this.db,appName:t}),this.getRunHistory=new qe({db:this.db,appName:t}),this.getQueriesPutFilesV1=new ve({db:this.db}),this.getEntitiesPutFilesV2=new he({db:this.db}),this.devices=new se,this.userManagement=new oe}async postMessage(e){let t;if(this.devices.isMatch(e)?t=await this.devices.responder(e):this.userManagement.isMatch(e)?t=await this.userManagement.responder(e):this.getJobs.isMatch(e)?t=await this.getJobs.responder(e):this.createJob.isMatch(e)?t=await this.createJob.responder(e):this.getJobDetails.isMatch(e)?t=await this.getJobDetails.responder(e):this.getAuditLog.isMatch(e)?t=await this.getAuditLog.responder(e):this.getRunHistory.isMatch(e)?t=await this.getRunHistory.responder(e):this.getQueriesPutFilesV1.isMatch(e)?t=await this.getQueriesPutFilesV1.responder(e):this.getEntitiesPutFilesV2.isMatch(e)?t=await this.getEntitiesPutFilesV2.responder(e):t=await super.postMessage(e),!t)throw new Error("Woops!");return console.log("MockBridge#postMessage: ",{message:e,value:t}),t}}export{Fe as MockBridge,ne as emptyScenario,Me as populatedScenario};
